#!/sbin/openrc-run
# Copyright (c) 2007-2015 The OpenRC Authors.
# See the Authors file at the top-level directory of this distribution and
# https://github.com/OpenRC/openrc/blob/master/AUTHORS
#
# This file is part of OpenRC. It is subject to the license terms in
# the LICENSE file found in the top-level directory of this
# distribution and at https://github.com/OpenRC/openrc/blob/master/LICENSE
# This file may not be copied, modified, propagated, or distributed
# except according to the terms contained in the LICENSE file.

name="natd"
description="Network Address Translation daemon"
command=/sbin/natd
pidfile="/var/run/${name}.pid"
sigstop="SIGKILL"
retry="30"

depend()
{
	need localmount
	use net
	keyword -jail -shutdown
}

start_pre()
{
	# Make sure our modules are loaded
	load_kld ipdivert

	if [ -n "${natd_interface}" ]; then
		dhcp_list="`list_net_interfaces dhcp`"
		for ifn in ${dhcp_list}; do
			case "${natd_interface}" in
			${ifn})
				command_args="$command_args -dynamic"
				;;
			esac
		done

		if echo "${natd_interface}" | \
		    grep -q -E '^[0-9]+(\.[0-9]+){0,3}$'; then
			command_args="$command_args -a ${natd_interface}"
		else
			command_args="$command_args -n ${natd_interface}"
		fi
	fi
	return 0
}
