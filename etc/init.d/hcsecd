#!/sbin/openrc-run
###################################
# OpenRC service file for the "hcsecd" daemon
# Written by Ken Moore <ken@ixsystems.com> 4/10/2018
# Available under the 2-clause BSD license
# 
###################################
#General Info/Settings
name="hcsecd"
description="Control link keys and PIN codes for Bluetooth devices"
command="/usr/sbin/${name}"
pidfile="/var/run/${name}.pid"
required_modules="ng_btsocket"
supervisor="supervise-daemon"

#Respect config file
config="${hcsecd_config:-/etc/bluetooth/${name}.conf}"
command_args="-d -f ${config}"
required_files="${config}"

depend(){
  before devd
  keyword -jail -shutdown
}

start_pre(){
  for i in ${required_modules}
  do
    kldload -n "${i}" >/dev/null 2>/dev/null
    if [ $? -ne 0 ] ; then
      eerror "Could not load required kernel module: ${i}"
      return 1
    fi
  done
  return 0
}
